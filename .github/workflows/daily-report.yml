name: Daily Campaign Report Update

on:
  schedule:
    # Se ejecuta todos los días a las 11:00 PM hora Colombia (4:00 AM UTC del día siguiente)
    # Obtiene datos del día actual (hoy)
    - cron: '0 4 * * *'
  
  # Permite ejecución manual desde GitHub
  workflow_dispatch:

jobs:
  update-bigquery:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create data directory
        run: mkdir -p data
      
      - name: Create tokens file
        run: echo '${{ secrets.TOKENS_JSON }}' > data/tokens.json
      
      - name: Create Google Cloud credentials
        run: echo '${{ secrets.GOOGLE_CREDENTIALS }}' > google-credentials.json
      
      - name: Create .env file
        run: |
          echo "BIGQUERY_ENABLED=true" >> .env
          echo "BIGQUERY_PROJECT_ID=${{ secrets.BIGQUERY_PROJECT_ID }}" >> .env
          echo "BIGQUERY_DATASET_ID=${{ secrets.BIGQUERY_DATASET_ID }}" >> .env
          echo "GOOGLE_APPLICATION_CREDENTIALS=./google-credentials.json" >> .env
          echo "GHL_API_KEY=${{ secrets.GHL_API_KEY }}" >> .env
          echo "GHL_LOCATION_ID=${{ secrets.GHL_LOCATION_ID }}" >> .env
      
      - name: Run Facebook report generation
        run: npm run specific-accounts
      
      - name: Run GHL report generation
        run: npm run ghl-report
      
      - name: Clean up credentials
        if: always()
        run: |
          rm -f google-credentials.json
          rm -f data/tokens.json
          rm -f .env

